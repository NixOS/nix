<section xmlns="http://docbook.org/ns/docbook"
         xmlns:xlink="http://www.w3.org/1999/xlink"
         xmlns:xi="http://www.w3.org/2001/XInclude"
         version="5.0"
         xml:id="ssec-binary-cache-substituter">

<title>Serving a Nix store via HTTP</title>

<para>You can easily share the Nix store of a machine via HTTP. This
allows other machines to fetch store paths from that machine to speed
up installations. It uses the same <emphasis>binary cache</emphasis>
mechanism that Nix usually uses to fetch pre-built binaries from
<uri>https://cache.nixos.org</uri>.</para>

<para>The daemon that handles binary cache requests via HTTP,
<command>nix-serve</command>, is not part of the Nix distribution, but
you can install it from Nixpkgs:

<screen>
$ nix-env -i nix-serve
</screen>

You can then start the server, listening for HTTP connections on
whatever port you like:

<screen>
$ nix-serve -p 8080
</screen>

To check whether it works, try the following on the client:

<screen>
$ curl http://avalon:8080/nix-cache-info
</screen>

which should print something like:

<screen>
StoreDir: /nix/store
WantMassQuery: 1
Priority: 30
</screen>

If you start <command>nix-serve</command> with the environment variable 
<envar>NIX_SECRET_KEY_FILE</envar>
set to a path to a secret key file generated by
<command linkend="rsec-nix-store-generate-binary-cache-key">nix-store</command>
<option linkend="rsec-nix-store-generate-binary-cache-key">--generate-binary-cache-key</option>
the served store paths will be signed with that key.

For example like

<screen>
$ NIX_SECRET_KEY_FILE=/path/to/secret/key nix-serve -p 8080
</screen>

</para>

<para>On the client side, you can tell Nix to use your binary cache
using <option>--option extra-substituters</option>, e.g.:

<screen>
$ nix-env -i firefox --option extra-substituters http://avalon:8080/
</screen>

The option <option>extra-substituters</option> tells Nix to use this
binary cache in addition to your default caches, such as
<uri>https://cache.nixos.org</uri>. Thus, for any path in the closure
of Firefox, Nix will first check if the path is available on the
server <literal>avalon</literal> or another binary caches. If not, it
will fall back to building from source.</para>

<para>You can also tell Nix to always use your binary cache by adding
a line to the <filename linkend="sec-conf-file">nix.conf</filename>
configuration file like this:

<programlisting>
substituters = http://avalon:8080/ https://cache.nixos.org/
</programlisting></para>

<para>Remember only trusted users can use the options <option linkend="conf-extra-substituters">extra-substituters</option>
or <option linkend="conf-substituters">substituters</option> on the command line, if you don't
add the binary cache to <option linkend="conf-substituters">substituters</option> or
<option linkend="conf-extra-substituters">extra-substituters</option> in <filename linkend="sec-conf-file">nix.conf</filename>.</para>

<para>If <option linkend="conf-require-sigs">require-sigs</option> is set to true (the default) you
need to add the corresponding public key to
<option linkend="conf-trusted-public-keys">trusted-public-keys</option> or the secret key
used above to <option linkend="conf-secret-key-files">secret-key-files</option> in your
<filename linkend="sec-conf-file">nix.conf</filename>.</para>


</section>
