#! @shell@ -e

url=$1

if test -z "$url"; then
    echo "syntax: nix-prefetch-url URL" >&2
    exit 1
fi

# !!! race? should be relatively safe, `svn export' barfs if $tmpPath exists.
tmpPath1=@storedir@/nix-prefetch-url-$$

# Perform the checkout.
@curl@ --fail --location --max-redirs 20 "$url" > $tmpPath1

# Compute the hash.
hash=$(@bindir@/nix-hash --flat $tmpPath1)
echo "hash is $hash" >&2

# Rename it so that the fetchsvn builder can find it.
tmpPath2=@storedir@/nix-prefetch-url-$hash
test -e $tmpPath2 || mv $tmpPath1 $tmpPath2 # !!! race

# Create a Nix expression that does a fetchsvn.
storeExpr=$( \
  echo "(import @datadir@/nix/corepkgs/fetchurl) \
        {url = $url; md5 = \"$hash\"; system = \"@system@\";}" \
  | nix-instantiate -)

# Realise it.
finalPath=$(nix-store -qnB --force-realise $storeExpr)

echo "path is $finalPath" >&2

rm -rf $tmpPath2 || true

echo $hash
